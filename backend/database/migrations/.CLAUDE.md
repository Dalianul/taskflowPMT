# Database Migrations - TaskFlow Schema

## Purpose & Responsibility
Laravel migration files defining the complete database schema for TaskFlow project management application. Manages table creation, relationships, indexes, and foreign key constraints in proper execution order.

## Key Files & Functions

### Laravel Default Migrations
1. **`0001_01_01_000000_create_users_table.php`**
   - Creates: users, password_reset_tokens, sessions tables
   - User authentication foundation

2. **`0001_01_01_000001_create_cache_table.php`**
   - Creates: cache, cache_locks tables
   - Supports Redis/database caching

3. **`0001_01_01_000002_create_jobs_table.php`**
   - Creates: jobs, job_batches, failed_jobs tables
   - Queue system for async operations

### TaskFlow Custom Migrations (2025_12_16_*)

#### Workspace Layer
**`000001_create_workspaces_table.php`**
- **Purpose:** Team/organization spaces
- **Columns:** id, name, slug (unique), description, logo, owner_id (FK→users), timestamps
- **Indexes:** owner_id
- **Cascade:** Delete workspace → deletes all projects, boards, tasks

**`000002_create_workspace_user_table.php`**
- **Purpose:** Many-to-many user-workspace membership with roles
- **Columns:** id, workspace_id (FK), user_id (FK), role (enum: owner/admin/member/viewer), joined_at, timestamps
- **Unique:** workspace_id + user_id (user can't join workspace twice)
- **Indexes:** workspace_id, user_id
- **Cascade:** Delete workspace or user → removes membership

**`000003_create_invitations_table.php`**
- **Purpose:** Workspace invitation system
- **Columns:** id, workspace_id (FK), email, token (unique 64 chars), role (enum: admin/member/viewer), invited_by (FK→users), expires_at, accepted_at (nullable), timestamps
- **Indexes:** workspace_id, email, token (unique)
- **Cascade:** Delete workspace or inviter → deletes invitation

#### Project Layer
**`000004_create_projects_table.php`**
- **Purpose:** Projects within workspaces
- **Columns:** id, workspace_id (FK), name, slug, description, color (#hex), icon, is_archived (bool), created_by (FK→users), timestamps
- **Unique:** workspace_id + slug (slug unique per workspace)
- **Indexes:** workspace_id, created_by, is_archived
- **Cascade:** Delete workspace → deletes project
- **Restrict:** Delete creator → prevents deletion (maintains audit trail)

#### Board Layer
**`000005_create_boards_table.php`**
- **Purpose:** Kanban boards within projects
- **Columns:** id, project_id (FK), name, slug, description, is_default (bool), created_by (FK→users), timestamps
- **Unique:** project_id + slug
- **Indexes:** project_id, created_by
- **Cascade:** Delete project → deletes board

**`000006_create_columns_table.php`**
- **Purpose:** Kanban columns (To Do, In Progress, Done)
- **Columns:** id, board_id (FK), name, position (int), color (#hex), limit (WIP limit, nullable), timestamps
- **Indexes:** board_id, (board_id + position) composite
- **Cascade:** Delete board → deletes column

**`000007_create_labels_table.php`**
- **Purpose:** Task categorization labels
- **Columns:** id, board_id (FK), name (100 chars), color (#hex), timestamps
- **Unique:** board_id + name (label name unique per board)
- **Indexes:** board_id
- **Cascade:** Delete board → deletes labels

#### Task Layer
**`000008_create_tasks_table.php`**
- **Purpose:** Individual task cards
- **Columns:**
  - id, column_id (FK), board_id (FK, denormalized), title (500 chars)
  - description (text), position (int), priority (enum: low/medium/high/urgent)
  - due_date (nullable), completed_at (nullable), created_by (FK→users), timestamps
- **Indexes:** column_id, board_id, (column_id + position) composite, due_date, priority, created_by
- **Cascade:** Delete column or board → deletes task
- **Design Note:** board_id denormalized for faster board-level queries (avoids JOIN through columns)

**`000009_create_task_user_table.php`**
- **Purpose:** Task assignments (many-to-many)
- **Columns:** id, task_id (FK), user_id (FK), assigned_by (FK→users, nullable), assigned_at, timestamps
- **Unique:** task_id + user_id (user can't be assigned twice)
- **Indexes:** task_id, user_id
- **Cascade:** Delete task or user → removes assignment

**`000010_create_task_label_table.php`**
- **Purpose:** Task labels (many-to-many)
- **Columns:** id, task_id (FK), label_id (FK), timestamps
- **Unique:** task_id + label_id
- **Indexes:** task_id, label_id
- **Cascade:** Delete task or label → removes association

#### Collaboration Layer
**`000011_create_comments_table.php`**
- **Purpose:** Task comments with threading
- **Columns:** id, task_id (FK), user_id (FK), content (text), parent_id (FK→comments, nullable), timestamps
- **Indexes:** task_id, user_id, parent_id
- **Cascade:** Delete task, user, or parent comment → deletes comment
- **Threading:** parent_id allows nested replies

**`000012_create_attachments_table.php`**
- **Purpose:** File uploads on tasks
- **Columns:** id, task_id (FK), user_id (FK), filename, original_name, mime_type (100 chars), size (bytes), path (500 chars), timestamps
- **Indexes:** task_id, user_id
- **Cascade:** Delete task or user → deletes attachment

#### Activity & Notification Layer
**`000013_create_activities_table.php`**
- **Purpose:** Audit log / activity timeline
- **Columns:**
  - id, workspace_id (FK, nullable), project_id (FK, nullable)
  - board_id (FK, nullable), task_id (FK, nullable), user_id (FK, nullable)
  - type (50 chars: task.created, task.moved, comment.added, etc.)
  - description (text), metadata (JSON), timestamps
- **Indexes:** workspace_id, project_id, board_id, task_id, user_id, type, created_at
- **Cascade:** Delete related entity → deletes activity
- **Design Note:** Multiple nullable FKs allow activities at different scopes

**`000014_create_notifications_table.php`**
- **Purpose:** User notification system
- **Columns:** id, user_id (FK), type (100 chars), notifiable_type (nullable), notifiable_id (nullable), data (JSON), read_at (nullable), timestamps
- **Indexes:** user_id, (user_id + read_at) composite, (notifiable_type + notifiable_id) composite
- **Cascade:** Delete user → deletes notifications
- **Polymorphic:** notifiable_type/notifiable_id allows notifications for any entity

## Dependencies & Relationships

### Migration Execution Order
Must run in numeric sequence (Laravel ensures this):
1. Users (Laravel default)
2. Workspaces (references users)
3. Workspace-user pivot (references workspaces + users)
4. Invitations (references workspaces + users)
5. Projects (references workspaces + users)
6. Boards (references projects + users)
7. Columns (references boards)
8. Labels (references boards)
9. Tasks (references columns + boards + users)
10. Task-user pivot (references tasks + users)
11. Task-label pivot (references tasks + labels)
12. Comments (references tasks + users + comments)
13. Attachments (references tasks + users)
14. Activities (references all entities)
15. Notifications (references users)

### Foreign Key Cascade Rules

**ON DELETE CASCADE:**
- Workspace deletion → cascades to projects, boards, tasks, activities, etc.
- Board deletion → cascades to columns, labels, tasks
- Task deletion → cascades to assignments, labels, comments, attachments

**ON DELETE RESTRICT:**
- User who created project/board/task → prevents deletion (audit trail)

**ON DELETE SET NULL:**
- User who performed activity → sets user_id to null (preserves activity log)
- User who assigned task → sets assigned_by to null

## Common Patterns & Usage

### Running Migrations
```bash
# Run all pending migrations
php artisan migrate

# Run migrations with fresh database
php artisan migrate:fresh

# Run migrations and seed data
php artisan migrate:fresh --seed

# Rollback last batch
php artisan migrate:rollback

# Check migration status
php artisan migrate:status
```

### Creating New Migrations
```bash
# Create migration
php artisan make:migration create_example_table

# Create migration with model
php artisan make:model Example -m
```

### Migration Best Practices
1. Never modify existing migrations after deployment
2. Create new migrations for schema changes
3. Use descriptive names: `create_[table]_table`, `add_[column]_to_[table]`
4. Always define down() method for rollback
5. Test rollback before deploying
6. Use transactions (Schema::create wraps in transaction automatically)

## Database Schema Summary

### Entity Hierarchy
```
Workspaces (team spaces)
  ├── workspace_user (members with roles)
  ├── invitations (pending invites)
  └── Projects
      └── Boards (Kanban boards)
          ├── Columns (To Do, In Progress, Done)
          ├── Labels (tags)
          └── Tasks (cards)
              ├── task_user (assignees)
              ├── task_label (tags)
              ├── Comments (with threading)
              └── Attachments (files)

Cross-cutting:
  ├── Activities (audit log for all entities)
  └── Notifications (user notifications)
```

### Table Counts
- **Core entities:** 11 tables (users, workspaces, projects, boards, columns, labels, tasks, comments, attachments, activities, notifications)
- **Pivot tables:** 3 tables (workspace_user, task_user, task_label)
- **Supporting:** 2 tables (invitations, personal_access_tokens from Sanctum)
- **Laravel system:** 6 tables (cache, jobs, sessions, password_reset_tokens, cache_locks, job_batches, failed_jobs)

**Total:** 16 custom TaskFlow tables + 9 Laravel system tables = 25 tables

### Index Strategy
- Primary key on all tables (id)
- Unique indexes on: slugs, tokens, pivot combinations
- Foreign key indexes for JOINs
- Composite indexes for common queries: (board_id, position), (workspace_id, slug)
- Date indexes for time-based queries: created_at, due_date

### Data Integrity
- All foreign keys defined with proper constraints
- Enum types for fixed value sets (role, priority)
- Nullable fields only where optional
- Timestamps on all tables for audit trail
- Unique constraints prevent duplicates

## Related Documentation
- Complete schema design: `../../../docs/database-schema.md`
- Backend structure: `../../../docs/backend-folder-structure.md`
- API endpoints: `../../../docs/api-endpoints.md`
