# Backend - Laravel API (TaskFlow)

## Purpose & Responsibility
Laravel 12 REST API backend providing authentication, real-time features, and complete CRUD operations for a Trello/Asana-style project management application.

## Tech Stack
- **Framework**: Laravel 12.0
- **PHP Version**: 8.3
- **Database**: MySQL (configured: taskflow database)
- **Cache/Session**: Redis
- **Queue**: Redis
- **Authentication**: Laravel Sanctum (API tokens)
- **Real-time**: Laravel Reverb (WebSocket server)
- **Broadcasting**: Pusher protocol

## Key Files & Functions

### Configuration
- `config/sanctum.php` - API authentication settings, CORS, stateful domains
- `config/reverb.php` - WebSocket server configuration (localhost:8080)
- `config/broadcasting.php` - Real-time broadcasting configuration
- `.env` - Environment variables (DB: root/admin123, Redis session/cache)

### Database
- `database/migrations/2025_12_16_*` - 14 custom migrations for complete schema
  - Workspaces, projects, boards, columns, tasks
  - Users, invitations, comments, attachments, labels
  - Activities (audit log), notifications
- `database/database.sqlite` - SQLite file for local development

### Models (To Be Created)
- `app/Models/User.php` - Current: basic auth model
- Need to create: Workspace, Project, Board, Column, Task, Label, Comment, Attachment, Activity, Notification, Invitation

### Routes
- `routes/api.php` - API endpoints (empty, needs ~120 endpoints)
- `routes/channels.php` - WebSocket channel authorization
- `routes/web.php` - Web routes (currently just welcome page)

### Controllers (To Be Created)
- `app/Http/Controllers/Api/Auth/` - Authentication endpoints
- `app/Http/Controllers/Api/Workspace/` - Workspace CRUD, members, invitations
- `app/Http/Controllers/Api/Project/` - Project management
- `app/Http/Controllers/Api/Board/` - Kanban board operations
- `app/Http/Controllers/Api/Task/` - Task CRUD, move, assign, complete
- See `docs/api-endpoints.md` for complete endpoint list

## Dependencies & Relationships

### Core Dependencies
```json
"laravel/sanctum": "^4.2"        // API token authentication
"laravel/reverb": "^1.0"         // WebSocket server
"predis/predis": "^3.3"          // Redis client
"pusher/pusher-php-server": "^7.2"  // Real-time messaging
```

### Integrates With
- **Frontend**: Next.js app at `../frontend/` (API consumer)
- **Database**: MySQL at 127.0.0.1:3306 (taskflow database)
- **Redis**: Session store, cache, queue at 127.0.0.1:6379
- **WebSocket**: Reverb server on localhost:8080

### External Services
- Email: Log driver (development), configure SMTP for production
- File Storage: Local disk at `storage/app/public/`

## Architecture Patterns

### Event-Driven Architecture
- Events: `app/Events/` (TaskCreated, TaskMoved, CommentAdded, etc.)
- Listeners: `app/Listeners/` (logging, notifications, broadcasting)
- Observers: `app/Observers/` (automatic activity tracking)

### Authorization
- Policies: `app/Policies/` (WorkspacePolicy, TaskPolicy, etc.)
- Middleware: `app/Http/Middleware/` (CheckWorkspaceAccess, CheckWorkspaceRole)

### Service Layer
- Services: `app/Services/` (TaskService, InvitationService, SearchService)
- Encapsulates complex business logic

### API Resources
- Resources: `app/Http/Resources/` (UserResource, TaskResource, BoardDetailResource)
- Consistent JSON response formatting

## Common Patterns & Usage

### Starting Development Server
```bash
cd backend
php artisan serve                    # API server (port 8000)
php artisan reverb:start            # WebSocket server (port 8080)
php artisan queue:listen            # Process queued jobs
php artisan pail                    # View logs in real-time
```

### Running Migrations
```bash
php artisan migrate                  # Run all migrations
php artisan migrate:fresh --seed    # Fresh DB with seed data
php artisan migrate:rollback        # Rollback last batch
```

### Creating Resources
```bash
php artisan make:model Workspace -mfrc  # Model + migration + factory + resource + controller
php artisan make:request StoreTaskRequest
php artisan make:policy TaskPolicy
php artisan make:event TaskCreated
php artisan make:listener LogTaskCreated
```

### Testing
```bash
php artisan test                    # Run PHPUnit tests
php artisan test --filter TaskTest  # Run specific test
```

### Code Quality
```bash
./vendor/bin/pint                   # Format code (Laravel Pint)
php artisan route:list              # List all routes
php artisan tinker                  # Interactive REPL
```

## Current State

### ‚úÖ Completed
- Laravel 12 framework installed and configured
- Database schema designed (14 migrations created)
- Sanctum authentication installed
- Reverb WebSocket server configured
- Redis cache and session configured
- Development environment setup

### ‚ö†Ô∏è In Progress / Pending
- [ ] Create Eloquent models for all entities
- [ ] Build API controllers (~27 controller classes)
- [ ] Define API routes (~120 endpoints)
- [ ] Create form request validation classes
- [ ] Build API resources for JSON responses
- [ ] Implement authorization policies
- [ ] Create event/listener classes for real-time updates
- [ ] Build service layer for business logic
- [ ] Write feature and unit tests

### üìù Notes
- Database schema follows relational design with proper foreign keys
- Denormalized `tasks.board_id` for performance optimization
- Use route model binding for cleaner controller code
- All API endpoints should return consistent JSON via Resources
- Real-time events broadcast to private channels (requires auth)
- See `docs/api-endpoints.md` for complete API specification

## Quick Reference

### Important Commands
```bash
# Development
composer install                     # Install dependencies
cp .env.example .env                 # Setup environment
php artisan key:generate             # Generate app key
php artisan storage:link             # Link storage to public

# Database
php artisan migrate                  # Run migrations
php artisan db:seed                  # Seed database
php artisan migrate:fresh --seed    # Fresh start

# Cache
php artisan cache:clear              # Clear application cache
php artisan config:clear             # Clear config cache
php artisan route:clear              # Clear route cache
```

### Environment Variables
```env
APP_URL=http://taskflow-backend.test
DB_DATABASE=taskflow
DB_USERNAME=root
DB_PASSWORD=admin123
REDIS_HOST=127.0.0.1
BROADCAST_DRIVER=reverb
REVERB_HOST=localhost
REVERB_PORT=8080
```

### API Base URL
- Development: `http://localhost:8000/api`
- Frontend expects: `http://taskflow-backend.test/api`

### WebSocket Connection
- URL: `ws://localhost:8080`
- App Key: `taskflow-key-local`
- Uses Pusher protocol

## Related Documentation
- Complete API spec: `../docs/api-endpoints.md`
- Database schema: `../docs/database-schema.md`
- Folder structure: `../docs/backend-folder-structure.md`
